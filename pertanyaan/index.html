<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kirim Pertanyaan ke Supervisor - Naik Level</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-b from-emerald-100 to-teal-200 text-emerald-900 font-sans flex flex-col">

  <!-- HEADER -->
  <header class="bg-emerald-700 text-white text-center py-4 shadow">
    <h1 class="text-lg font-bold">ğŸ’¬ Kirim Pertanyaan ke Supervisor</h1>
    <p class="text-sm opacity-90">Tulis pertanyaanmu seputar riyadhah, batin, atau refleksi spiritual</p>
  </header>

  <!-- FORM KIRIM PERTANYAAN -->
  <main class="flex-1 max-w-md w-full mx-auto p-4">
    <div class="bg-white rounded-xl shadow p-4 mb-6">
      <textarea id="pertanyaanInput" rows="3" placeholder="Tulis pertanyaanmu di sini..." 
        class="w-full border border-emerald-200 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-emerald-400"></textarea>
      <button id="kirimBtn" 
        class="mt-3 bg-emerald-700 hover:bg-emerald-800 text-white w-full py-2 rounded-lg font-semibold">
        ğŸ“© Kirim Pertanyaan
      </button>
      <div id="notif" class="hidden mt-3 text-center text-sm font-semibold text-emerald-700"></div>
    </div>

    <div class="bg-white rounded-xl shadow p-4">
      <h2 class="text-md font-semibold text-emerald-700 mb-2">ğŸ’­ Pertanyaanmu</h2>
      <div id="pertanyaanList">ğŸ”„ Memuat pertanyaanmu...</div>
    </div>
  </main>

  <footer class="text-center py-3 text-xs text-emerald-900">
    Â© 2025 Naik Level â€¢ Pesantren Fajrul Islam
  </footer>

  <!-- FIREBASE SCRIPT -->
  <script type="module">
    import { app } from "../assets/firebase-config.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { checkUser } from "../assets/script.js";

    const db = getFirestore(app);
    const user = checkUser();
    const input = document.getElementById("pertanyaanInput");
    const btn = document.getElementById("kirimBtn");
    const notif = document.getElementById("notif");
    const list = document.getElementById("pertanyaanList");

    // === FUNGSI KIRIM PERTANYAAN ===
    btn.addEventListener("click", async () => {
      const isi = input.value.trim();
      if (!isi) {
        alert("Tulis pertanyaan terlebih dahulu.");
        return;
      }

      try {
        const namaUser = user?.username || "Anonim";
        await addDoc(collection(db, "pertanyaanSalik"), {
          isi: isi,
          dari: namaUser,
          waktu: serverTimestamp(),
          status: "belum dijawab"
        });
        notif.textContent = "âœ… Pertanyaan berhasil dikirim.";
        notif.classList.remove("hidden");
        input.value = "";
        loadPertanyaan();
      } catch (err) {
        console.error("âŒ Gagal mengirim:", err);
        notif.textContent = "âŒ Gagal mengirim pertanyaan. Periksa koneksi.";
        notif.classList.remove("hidden");
      }
    });

    // === FUNGSI MUAT PERTANYAAN SALIK SENDIRI ===
    async function loadPertanyaan() {
      list.innerHTML = "ğŸ”„ Memuat pertanyaanmu...";
      try {
        const namaUser = user?.username || "Anonim";

        const q = query(
          collection(db, "pertanyaanSalik"),
          where("dari", "==", namaUser),
          orderBy("waktu", "desc")
        );
        const snap = await getDocs(q);

        if (snap.empty) {
          list.innerHTML = "<p class='text-gray-500 italic text-sm'>Belum ada pertanyaan yang kamu kirim.</p>";
          return;
        }

        let html = "";
        snap.forEach(doc => {
          const d = doc.data();
          const waktu = d.waktu ? new Date(d.waktu.toDate()).toLocaleString() : "-";
          const jawaban = d.jawaban 
            ? `<div class='mt-2 p-2 bg-emerald-50 border border-emerald-100 rounded-lg text-sm'>
                 <strong>ğŸ•Šï¸ Jawaban Supervisor:</strong><br>${d.jawaban}
               </div>` 
            : `<p class='text-xs text-gray-400 italic mt-1'>Belum dijawab</p>`;

          html += `
            <div class="border border-emerald-200 rounded-lg p-2 mb-3 bg-emerald-50">
              <p>${d.isi}</p>
              <small class="text-gray-500 text-xs">${waktu}</small>
              ${jawaban}
            </div>`;
        });

        list.innerHTML = html;
      } catch (err) {
        console.error("âŒ Gagal memuat pertanyaan:", err);
        list.innerHTML = "<p class='text-red-500 text-sm'>âŒ Gagal memuat pertanyaan.</p>";
      }
    }

    loadPertanyaan();
  </script>
</body>
</html>
