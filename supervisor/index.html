<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Supervisor - Naik Level</title>
  <link rel="stylesheet" href="../assets/style.css">
  <style>
    body {
      font-family: "Poppins", system-ui, sans-serif;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .card-menu {
      background: #ecfdf5;
      border-radius: 16px;
      padding: 1.5rem;
      text-align: center;
      border: 1px solid #a7f3d0;
      transition: all 0.25s ease;
      cursor: pointer;
    }

    .card-menu:hover {
      background: #d1fae5;
      transform: translateY(-4px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.05);
    }

    .card-menu h3 {
      margin-top: 10px;
      color: #065f46;
      font-size: 1rem;
    }

    .card-menu p {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .table-box {
      margin-top: 2rem;
      background: #ffffff;
      border-radius: 14px;
      padding: 1rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }

    th {
      background: #ecfdf5;
      color: #065f46;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background: #f9fafb;
    }

    button.refresh-btn {
      margin-top: 1rem;
      background: #059669;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.6rem;
      font-weight: 600;
      margin-right: 4px;
    }

    .badge-1 { background:#bbf7d0; color:#166534; }
    .badge-2 { background:#a5f3fc; color:#075985; }
    .badge-3 { background:#fee2e2; color:#991b1b; }

    .small-text {
      font-size: 0.7rem;
      color: #6b7280;
    }
  </style>
</head>

<body>
  <header>
    <img src="../assets/logoslu.png" class="logo">
    <h2>üåø Dashboard Supervisor Naik Level</h2>
    <p>Pusat pemantauan asasmen, laporan, dan irsyad santri</p>
  </header>

  <main class="fade-in">
    <section class="menu-grid">
      <!-- Asesmen Pengasuh -->
      <div class="card-menu" onclick="loadData('asasmen_pengasuh')">
        <h3>üßï Asasmen Pengasuh</h3>
        <p>Lihat 3 level batin paling dominan dari setiap pengasuh</p>
      </div>

      <div class="card-menu" onclick="window.location.href='../irsyad/supervisor.html'">
        <h3>üïäÔ∏è Tulis Irsyad</h3>
        <p>Buat dan kirim bimbingan spiritual kepada Salik</p>
      </div>

      <div class="card-menu" onclick="loadData('asasmen_santri')">
        <h3>üìò Asasmen Santri</h3>
        <p>Lihat hasil refleksi spiritual santri</p>
      </div>

      <div class="card-menu" onclick="loadData('laporan_harian')">
        <h3>üìñ Laporan Harian</h3>
        <p>Pantau rutinitas harian santri</p>
      </div>

      <div class="card-menu" onclick="loadData('laporan_pekanan')">
        <h3>üìÜ Laporan Pekanan</h3>
        <p>Tinjau pertumbuhan mingguan</p>
      </div>

      <div class="card-menu" onclick="loadData('irsyad')">
        <h3>üí¨ Data Irsyad</h3>
        <p>Lihat semua pesan bimbingan yang telah dikirim</p>
      </div>
    </section>

    <section class="table-box">
      <h3 id="tableTitle">üìä Data Asasmen / Laporan</h3>
      <div id="dataContainer">
        <p>Pilih salah satu menu di atas untuk melihat data.</p>
      </div>
      <button class="refresh-btn" id="refreshBtn" style="display:none;">üîÑ Segarkan Data</button>
    </section>
  </main>

  <footer>¬© 2025 Naik Level ‚Ä¢ Pesantren Fajrul Islam</footer>

  <script type="module">
    import { app } from "../assets/firebase-config.js";
    import {
  getFirestore,
  collection,
  getDocs,
  orderBy,
  query,
  limit
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";


    const db = getFirestore(app);
    const user = checkUser(); // ini otomatis memastikan role supervisor

    const dataContainer = document.getElementById("dataContainer");
    const title = document.getElementById("tableTitle");
    const refreshBtn = document.getElementById("refreshBtn");

    function formatDate(value) {
      if (!value || !value.toDate) return "-";
      const d = value.toDate();
      const dd = String(d.getDate()).padStart(2, "0");
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");
      return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
    }

    function renderTop3(top3 = []) {
      if (!Array.isArray(top3) || top3.length === 0) {
        return `<span class="small-text">Belum ada ringkasan level.</span>`;
      }

      return top3.slice(0, 3).map((t, i) => {
        const badgeClass = i === 0 ? "badge-1" : i === 1 ? "badge-2" : "badge-3";
        const levelName = t.name || `Level ${t.level || "-"}`;
        return `
          <div style="margin-bottom:2px;">
            <span class="badge ${badgeClass}">${i + 1}</span>
            <span style="font-weight:600;">${levelName}</span>
            <span class="small-text"> ¬∑ skor: ${t.score ?? "-"}</span>
          </div>
        `;
      }).join("");
    }

    window.loadData = async function(type) {
      let niceName = "";
      switch (type) {
        case "asasmen_pengasuh": niceName = "Asasmen Pengasuh"; break;
        case "asasmen_santri": niceName = "Asasmen Santri"; break;
        case "laporan_harian": niceName = "Laporan Harian"; break;
        case "laporan_pekanan": niceName = "Laporan Pekanan"; break;
        case "irsyad": niceName = "Data Irsyad"; break;
        default: niceName = type.replace("_", " ");
      }

      title.textContent = "üìä Memuat data " + niceName + "...";
      dataContainer.innerHTML = "<p>‚è≥ Mengambil data dari server...</p>";

      try {
        const q = query(collection(db, type), limit(50));

        const docsSnap = await getDocs(q);

        if (docsSnap.empty) {
          dataContainer.innerHTML = "<p>Tidak ada data yang ditemukan.</p>";
          refreshBtn.style.display = "none";
          return;
        }

      if (type === "asasmen_pengasuh") {
  let html = `
    <table>
      <thead>
        <tr>
          <th>No</th>
          <th>Nama Pengasuh</th>
          <th>Tanggal Asasmen</th>
          <th>3 Level Dominan</th>
        </tr>
      </thead>
      <tbody>
  `;

  let index = 1;
  docsSnap.forEach(doc => {
    const data = doc.data();
    const nama = data.nama || "-";
    const tanggal = data.tanggal || "-";
    const hasil = data.hasil || {};

    // Ambil tiga level tertinggi
    const top3 = Object.entries(hasil)
      .map(([level, score]) => ({ name: level, score }))
      .sort((a, b) => b.score - a.score)
      .slice(0, 3);

    const top3Html = renderTop3(top3);

    html += `
      <tr>
        <td>${index}</td>
        <td><strong>${nama}</strong></td>
        <td class="small-text">${tanggal}</td>
        <td>${top3Html}</td>
      </tr>
    `;
    index++;
  });

  html += `</tbody></table>`;
  dataContainer.innerHTML = html;
  title.textContent = "üìä Data: " + niceName;
  refreshBtn.style.display = "block";
  refreshBtn.onclick = () => loadData(type);
  return;
}

        // ===========================
        // GENERIC VIEW UNTUK KOLEKSI LAIN
        // ===========================
        let html = `<table><thead><tr>`;
        const first = docsSnap.docs[0].data();
        Object.keys(first).forEach(key => {
          html += `<th>${key}</th>`;
        });
        html += `</tr></thead><tbody>`;

        docsSnap.forEach(doc => {
          const data = doc.data();
          html += `<tr>`;
          Object.values(data).forEach(v => {
            if (typeof v === "object" && v?.toDate) {
              html += `<td>${v.toDate().toLocaleString()}</td>`;
            } else if (typeof v === "object") {
              html += `<td>${JSON.stringify(v)}</td>`;
            } else {
              html += `<td>${v}</td>`;
            }
          });
          html += `</tr>`;
        });

        html += `</tbody></table>`;
        dataContainer.innerHTML = html;
        title.textContent = "üìä Data: " + niceName;
        refreshBtn.style.display = "block";
        refreshBtn.onclick = () => loadData(type);

      } catch (err) {
        console.error(err);
        dataContainer.innerHTML = `<p>‚ö†Ô∏è Gagal memuat data: ${err.message}</p>`;
        refreshBtn.style.display = "none";
      }
    }
  </script>
</body>
</html>
