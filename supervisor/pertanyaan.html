<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pertanyaan Salik - Naik Level</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-b from-emerald-100 to-teal-200 font-sans text-emerald-900">

  <!-- HEADER -->
  <header class="bg-emerald-700 text-white py-4 text-center shadow">
    <h2 class="text-lg font-bold">â“ Pertanyaan dari Para Salik</h2>
    <p class="text-sm opacity-90">Berikan jawaban atau arahan atas pertanyaan yang masuk</p>
  </header>

  <!-- LIST PERTANYAAN -->
  <main class="max-w-3xl mx-auto p-5">
    <div id="pertanyaanList" class="bg-white rounded-2xl shadow p-5">
      ğŸ”„ Memuat pertanyaan...
    </div>
  </main>

  <footer class="text-center text-xs text-emerald-900 py-3">
    Â© 2025 Naik Level â€¢ Pesantren Fajrul Islam
  </footer>

  <script type="module">
    import { app } from "../assets/firebase-config.js";   // â¬…ï¸ PERHATIKAN: ../ bukan ../../
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      orderBy,
      updateDoc,
      doc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const db = getFirestore(app);
    const pertanyaanList = document.getElementById("pertanyaanList");

    async function loadPertanyaan() {
      pertanyaanList.innerHTML = "ğŸ”„ Memuat pertanyaan...";
      try {
        // ambil semua pertanyaan salik, urut dari terbaru
        const q = query(collection(db, "pertanyaanSalik"), orderBy("waktu", "desc"));
        const snap = await getDocs(q);

        if (snap.empty) {
          pertanyaanList.innerHTML = "<p class='text-sm text-gray-500 italic'>Belum ada pertanyaan dari salik.</p>";
          return;
        }

        let html = "";
        snap.forEach(docSnap => {
          const d = docSnap.data();
          const waktu = d.waktu ? new Date(d.waktu.toDate()).toLocaleString() : "-";
          const jawabanSudahAda = !!d.jawaban;

          html += `
            <div class="border border-emerald-200 rounded-lg p-4 mb-4 bg-emerald-50">
              <p class="mb-1"><strong>${d.dari}</strong> bertanya:</p>
              <p class="mb-1">${d.isi}</p>
              <small class="text-xs text-gray-500">${waktu}</small>

              ${jawabanSudahAda
                ? `
                  <div class="mt-3 p-2 bg-white border border-emerald-100 rounded">
                    <strong>Jawaban Anda:</strong>
                    <p>${d.jawaban}</p>
                    <small class="text-xs text-gray-500">
                      ${d.waktuJawab ? new Date(d.waktuJawab.toDate()).toLocaleString() : ""}
                    </small>
                  </div>
                `
                : `
                  <textarea id="jawaban-${docSnap.id}" rows="2"
                    class="w-full border border-emerald-200 rounded-lg p-2 mt-3 text-sm
                           focus:outline-none focus:ring-2 focus:ring-emerald-400"
                    placeholder="Tulis jawaban atau arahan di sini..."></textarea>
                  <button
                    class="mt-2 bg-emerald-600 hover:bg-emerald-700 text-white text-sm px-4 py-1 rounded"
                    data-id="${docSnap.id}">
                    ğŸ’¬ Kirim Jawaban
                  </button>
                `}
            </div>
          `;
        });

        pertanyaanList.innerHTML = html;

        // event klik untuk semua tombol "Kirim Jawaban"
        document.querySelectorAll("button[data-id]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            const textarea = document.getElementById(`jawaban-${id}`);
            const isi = textarea.value.trim();
            if (!isi) {
              alert("Tulis jawaban terlebih dahulu.");
              return;
            }
            try {
              await updateDoc(doc(db, "pertanyaanSalik", id), {
                jawaban: isi,
                dijawabOleh: "Abah Multazam Zakaria",
                waktuJawab: serverTimestamp(),
                status: "dijawab"
              });
              alert("âœ… Jawaban terkirim.");
              loadPertanyaan();
            } catch (err) {
              console.error("âŒ Gagal mengirim jawaban:", err);
              alert("âŒ Gagal mengirim jawaban.");
            }
          });
        });

      } catch (err) {
        console.error("âŒ Gagal memuat pertanyaan:", err);
        pertanyaanList.innerHTML =
          "<p class='text-sm text-red-500'>Terjadi kesalahan saat memuat pertanyaan.</p>";
      }
    }

    loadPertanyaan();
  </script>
</body>
</html>
