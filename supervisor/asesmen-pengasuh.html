<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supervisor - Asasmen Pengasuh</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-b from-sky-700 to-indigo-600 min-h-screen font-sans text-gray-800">
  <!-- HEADER -->
  <header class="bg-white/20 backdrop-blur-md text-center text-white py-4 shadow">
    <h1 class="text-2xl font-bold">ğŸ“Š Dashboard Supervisor</h1>
    <p class="text-sm opacity-90">Hasil Asasmen Spiritual Pengasuh</p>
  </header>

  <main class="max-w-5xl mx-auto mt-8 bg-white p-8 rounded-2xl shadow-lg">
    <div class="flex flex-wrap justify-between items-center gap-3 mb-6">
      <h2 class="text-xl font-bold text-emerald-700">Rekap Asasmen Pengasuh</h2>
      <div class="flex flex-wrap gap-2">
        <button id="refresh-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition">
          ğŸ”„ Refresh Data
        </button>
        <button id="toggle-delete-panel" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
          ğŸ—‘ï¸ Hapus Database
        </button>
      </div>
    </div>

    <!-- PANEL HAPUS DATABASE -->
    <div id="delete-panel" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <h3 class="font-semibold text-red-700 mb-2">âš ï¸ Hapus Data Berdasarkan Rentang Waktu</h3>
      <p class="text-sm text-gray-700 mb-4">
        Pilih tanggal <strong>awal</strong> dan <strong>akhir</strong> untuk menghapus data asesmen yang dibuat di rentang waktu tersebut.
      </p>

      <div class="flex flex-wrap gap-3 mb-4">
        <div>
          <label for="startDate" class="block text-xs font-semibold text-gray-600 mb-1">Dari Tanggal:</label>
          <input type="date" id="startDate" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
        </div>
        <div>
          <label for="endDate" class="block text-xs font-semibold text-gray-600 mb-1">Sampai Tanggal:</label>
          <input type="date" id="endDate" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
        </div>
      </div>

      <button id="delete-range-btn"
        class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-md shadow transition">
        ğŸš¨ Hapus Data Dalam Rentang Ini
      </button>
    </div>

    <!-- LOADING -->
    <div id="loading" class="text-center text-gray-500">
      â³ Memuat data dari Firebase...
    </div>

    <!-- TABEL DATA -->
    <div id="data-container" class="hidden overflow-x-auto">
      <table class="w-full text-sm border border-gray-300">
        <thead class="bg-emerald-700 text-white">
          <tr>
            <th class="py-2 px-3 border">No</th>
            <th class="py-2 px-3 border">Nama Pengasuh</th>
            <th class="py-2 px-3 border">Tanggal</th>
            <th class="py-2 px-3 border">Level Dominan 1</th>
            <th class="py-2 px-3 border">Level Dominan 2</th>
            <th class="py-2 px-3 border">Level Dominan 3</th>
          </tr>
        </thead>
        <tbody id="tabel-body" class="text-center"></tbody>
      </table>
    </div>
  </main>

  <!-- FIREBASE SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      deleteDoc,
      doc,
      query
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDuxvufRwadUsGh8-Kakl9KTG5ZGVcIoYQ",
      authDomain: "naik-level-81580.firebaseapp.com",
      projectId: "naik-level-81580",
      storageBucket: "naik-level-81580.firebasestorage.app",
      messagingSenderId: "319872430378",
      appId: "1:319872430378:web:64db1b51b159d27d622e53",
      measurementId: "G-RG7JS79MZ1"
    };

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Elemen DOM
    const tabelBody       = document.getElementById("tabel-body");
    const loading         = document.getElementById("loading");
    const dataContainer   = document.getElementById("data-container");
    const refreshBtn      = document.getElementById("refresh-btn");
    const toggleDeleteBtn = document.getElementById("toggle-delete-panel");
    const deletePanel     = document.getElementById("delete-panel");
    const deleteRangeBtn  = document.getElementById("delete-range-btn");
    const startDateInput  = document.getElementById("startDate");
    const endDateInput    = document.getElementById("endDate");

    // ============================
    // ğŸ”¹ Load data dari Firestore
    // ============================
    async function loadData() {
      loading.classList.remove("hidden");
      dataContainer.classList.add("hidden");
      tabelBody.innerHTML = "";

      try {
        const q = query(collection(db, "asasmen_pengasuh"));
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          loading.textContent = "Belum ada data asesmen.";
          return;
        }

        let no = 1;
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const hasil = data.hasil || {};

          const sorted = Object.entries(hasil)
            .map(([level, score]) => ({ level, score }))
            .sort((a, b) => b.score - a.score)
            .slice(0, 3);

          const top1 = sorted[0] ? `${sorted[0].level} (${sorted[0].score})` : "-";
          const top2 = sorted[1] ? `${sorted[1].level} (${sorted[1].score})` : "-";
          const top3 = sorted[2] ? `${sorted[2].level} (${sorted[2].score})` : "-";

          const tr = `
            <tr class="odd:bg-gray-50 even:bg-gray-100 hover:bg-emerald-50 transition">
              <td class="border px-3 py-2">${no++}</td>
              <td class="border px-3 py-2 font-semibold text-left">${data.nama || "-"}</td>
              <td class="border px-3 py-2">${data.tanggal || "-"}</td>
              <td class="border px-3 py-2 text-emerald-700 font-semibold">${top1}</td>
              <td class="border px-3 py-2">${top2}</td>
              <td class="border px-3 py-2">${top3}</td>
            </tr>
          `;
          tabelBody.innerHTML += tr;
        });

        loading.classList.add("hidden");
        dataContainer.classList.remove("hidden");
      } catch (err) {
        console.error("âŒ Error:", err);
        loading.textContent = "Terjadi kesalahan saat memuat data.";
      }
    }

    // ============================
    // ğŸ§¹ Panel hapus database toggle
    // ============================
    toggleDeleteBtn.addEventListener("click", () => {
      deletePanel.classList.toggle("hidden");
    });

    // ============================
    // ğŸ—‘ï¸ Hapus berdasarkan rentang waktu
    // ============================
    async function deleteByDateRange() {
      const startDate = startDateInput.value;
      const endDate   = endDateInput.value;

      if (!startDate || !endDate) {
        alert("âš ï¸ Silakan pilih tanggal awal dan akhir terlebih dahulu.");
        return;
      }

      if (startDate > endDate) {
        alert("âš ï¸ Tanggal awal tidak boleh setelah tanggal akhir.");
        return;
      }

      const konfirmasi1 = confirm(`Anda akan menghapus data antara ${startDate} dan ${endDate}. Lanjutkan?`);
      if (!konfirmasi1) return;
      const konfirmasi2 = confirm("â— Data yang dihapus tidak bisa dikembalikan. Yakin lanjut?");
      if (!konfirmasi2) return;

      try {
        const q = query(collection(db, "asasmen_pengasuh"));
        const snapshot = await getDocs(q);

        let count = 0;
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          if (!data.tanggal) continue;

          // Ubah ke format Date agar bisa dibandingkan
          const tanggalStr = data.tanggal.split(" ")[0];
          const [hari, bulan, tahun] = tanggalStr.split("/").map(Number);
          const tglData = new Date(tahun, bulan - 1, hari);

          const start = new Date(startDate);
          const end   = new Date(endDate);
          end.setHours(23, 59, 59, 999);

          if (tglData >= start && tglData <= end) {
            await deleteDoc(doc(db, "asasmen_pengasuh", docSnap.id));
            count++;
          }
        }

        alert(`âœ… ${count} data berhasil dihapus dalam rentang ${startDate} s.d ${endDate}.`);
        loadData();
      } catch (err) {
        console.error("âŒ Gagal menghapus data:", err);
        alert("Terjadi kesalahan saat menghapus data.");
      }
    }

    deleteRangeBtn.addEventListener("click", deleteByDateRange);
    refreshBtn.addEventListener("click", loadData);

    // Load awal
    loadData();
  </script>
</body>
</html>
