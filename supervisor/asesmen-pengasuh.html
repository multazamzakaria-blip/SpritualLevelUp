<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supervisor - Asasmen Pengasuh</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-gradient-to-b from-sky-700 to-indigo-600 min-h-screen font-sans text-gray-800">
  <!-- HEADER -->
  <header class="bg-white/20 backdrop-blur-md text-center text-white py-4 shadow">
    <h1 class="text-2xl font-bold">ğŸ“Š Dashboard Supervisor</h1>
    <p class="text-sm opacity-90">Hasil Asasmen Spiritual Pengasuh</p>
  </header>

  <main class="max-w-6xl mx-auto mt-8 bg-white p-8 rounded-2xl shadow-lg">
    <div class="flex flex-wrap justify-between items-center gap-3 mb-6">
      <h2 class="text-xl font-bold text-emerald-700">Rekap Asasmen Pengasuh</h2>
      <div class="flex flex-wrap gap-2">
        <button id="refresh-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition">
          ğŸ”„ Refresh
        </button>
        <button id="toggle-delete-panel" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition">
          âš™ï¸ Filter / Hapus
        </button>
        <button id="export-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition">
          ğŸ“¤ Ekspor Excel
        </button>
      </div>
    </div>

    <!-- PANEL FILTER & HAPUS -->
    <div id="delete-panel" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
      <h3 class="font-semibold text-emerald-700 mb-2">ğŸ—“ï¸ Filter & Hapus Berdasarkan Tanggal</h3>
      <div class="flex flex-wrap gap-3 mb-4">
        <div>
          <label for="startDate" class="block text-xs font-semibold text-gray-600 mb-1">Dari Tanggal:</label>
          <input type="date" id="startDate" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
        </div>
        <div>
          <label for="endDate" class="block text-xs font-semibold text-gray-600 mb-1">Sampai Tanggal:</label>
          <input type="date" id="endDate" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
        </div>
      </div>

      <div class="flex flex-wrap gap-3">
        <button id="filter-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded-md shadow transition">
          ğŸ” Tampilkan Hanya Rentang Ini
        </button>
        <button id="delete-range-btn" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-md shadow transition">
          ğŸš¨ Hapus Data Dalam Rentang Ini
        </button>
      </div>
    </div>

    <!-- LOADING -->
    <div id="loading" class="text-center text-gray-500">
      â³ Memuat data dari Firebase...
    </div>

    <!-- TABEL DATA -->
    <div id="data-container" class="hidden overflow-x-auto">
      <table class="w-full text-sm border border-gray-300">
        <thead class="bg-emerald-700 text-white">
          <tr>
            <th class="py-2 px-3 border">No</th>
            <th class="py-2 px-3 border">Nama Pengasuh</th>
            <th class="py-2 px-3 border">Tanggal</th>
            <th class="py-2 px-3 border">Level Dominan 1</th>
            <th class="py-2 px-3 border">Level Dominan 2</th>
            <th class="py-2 px-3 border">Level Dominan 3</th>
            <th class="py-2 px-3 border">Aksi</th>
          </tr>
        </thead>
        <tbody id="tabel-body" class="text-center"></tbody>
      </table>
    </div>
  </main>

  <!-- FIREBASE SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      deleteDoc,
      doc,
      query
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ğŸ”¥ Konfigurasi Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDuxvufRwadUsGh8-Kakl9KTG5ZGVcIoYQ",
      authDomain: "naik-level-81580.firebaseapp.com",
      projectId: "naik-level-81580",
      storageBucket: "naik-level-81580.firebasestorage.app",
      messagingSenderId: "319872430378",
      appId: "1:319872430378:web:64db1b51b159d27d622e53",
      measurementId: "G-RG7JS79MZ1"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ğŸ”¸ Elemen DOM
    const tabelBody       = document.getElementById("tabel-body");
    const loading         = document.getElementById("loading");
    const dataContainer   = document.getElementById("data-container");
    const refreshBtn      = document.getElementById("refresh-btn");
    const toggleDeleteBtn = document.getElementById("toggle-delete-panel");
    const deletePanel     = document.getElementById("delete-panel");
    const deleteRangeBtn  = document.getElementById("delete-range-btn");
    const filterBtn       = document.getElementById("filter-btn");
    const startDateInput  = document.getElementById("startDate");
    const endDateInput    = document.getElementById("endDate");
    const exportBtn       = document.getElementById("export-btn");

    let semuaData = [];

    // ğŸ”¹ Parsing tanggal fleksibel
    function parseTanggal(tanggalStr) {
      if (!tanggalStr) return null;
      const bagianTanggal = tanggalStr.split(" ")[0];
      if (bagianTanggal.includes("/")) {
        const [d, m, y] = bagianTanggal.split("/").map(Number);
        return new Date(y, m - 1, d);
      }
      if (bagianTanggal.includes("-")) {
        const [y, m, d] = bagianTanggal.split("-").map(Number);
        return new Date(y, m - 1, d);
      }
      const t = new Date(bagianTanggal);
      return isNaN(t.getTime()) ? null : t;
    }

    // ğŸ”¹ LOAD DATA
    async function loadData() {
      loading.classList.remove("hidden");
      dataContainer.classList.add("hidden");
      tabelBody.innerHTML = "";

      const q = query(collection(db, "asasmen_pengasuh"));
      const snapshot = await getDocs(q);
      semuaData = [];

      snapshot.forEach(docSnap => {
        semuaData.push({ id: docSnap.id, ...docSnap.data() });
      });

      tampilkanData(semuaData);
    }

    // ğŸ”¹ TAMPILKAN DATA
    function tampilkanData(dataList) {
      tabelBody.innerHTML = "";
      if (dataList.length === 0) {
        tabelBody.innerHTML = `<tr><td colspan="7" class="py-4 text-gray-500 italic">Tidak ada data ditemukan.</td></tr>`;
      } else {
        let no = 1;
        dataList.forEach(data => {
          const hasil = data.hasil || {};
          const sorted = Object.entries(hasil)
            .map(([level, score]) => ({ level, score }))
            .sort((a, b) => b.score - a.score)
            .slice(0, 3);

          const top1 = sorted[0] ? `${sorted[0].level} (${sorted[0].score})` : "-";
          const top2 = sorted[1] ? `${sorted[1].level} (${sorted[1].score})` : "-";
          const top3 = sorted[2] ? `${sorted[2].level} (${sorted[2].score})` : "-";

          const tr = document.createElement("tr");
          tr.className = "odd:bg-gray-50 even:bg-gray-100 hover:bg-emerald-50 transition";
          tr.innerHTML = `
            <td class="border px-3 py-2">${no++}</td>
            <td class="border px-3 py-2 text-left font-semibold">${data.nama || "-"}</td>
            <td class="border px-3 py-2">${data.tanggal || "-"}</td>
            <td class="border px-3 py-2 text-emerald-700 font-semibold">${top1}</td>
            <td class="border px-3 py-2">${top2}</td>
            <td class="border px-3 py-2">${top3}</td>
            <td class="border px-3 py-2">
              <button class="hapus-btn bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded-md" data-id="${data.id}">
                ğŸ—‘ï¸ Hapus
              </button>
            </td>
          `;
          tabelBody.appendChild(tr);
        });
      }

      loading.classList.add("hidden");
      dataContainer.classList.remove("hidden");

      document.querySelectorAll(".hapus-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          if (confirm("Yakin ingin menghapus data ini?")) {
            await deleteDoc(doc(db, "asasmen_pengasuh", id));
            btn.closest("tr").remove();
          }
        });
      });
    }

    // ğŸ”¹ FILTER DATA
    function filterByDate() {
      const start = startDateInput.value ? new Date(startDateInput.value) : null;
      const end = endDateInput.value ? new Date(endDateInput.value) : null;
      if (!start || !end) {
        alert("Silakan pilih tanggal awal dan akhir.");
        return;
      }
      end.setHours(23, 59, 59, 999);

      const filtered = semuaData.filter(data => {
        const tglData = parseTanggal(data.tanggal);
        return tglData && tglData >= start && tglData <= end;
      });

      tampilkanData(filtered);
    }

    // ğŸ”¹ HAPUS RENTANG
    async function deleteByDateRange() {
      const start = startDateInput.value;
      const end = endDateInput.value;
      if (!start || !end) {
        alert("Silakan isi tanggal awal dan akhir terlebih dahulu.");
        return;
      }

      if (!confirm(`Anda akan menghapus data antara ${start} s.d ${end}. Yakin?`)) return;

      const startD = new Date(start);
      const endD = new Date(end);
      endD.setHours(23, 59, 59, 999);

      let count = 0;
      for (const d of semuaData) {
        const tglData = parseTanggal(d.tanggal);
        if (tglData && tglData >= startD && tglData <= endD) {
          await deleteDoc(doc(db, "asasmen_pengasuh", d.id));
          count++;
        }
      }
      alert(`âœ… ${count} data berhasil dihapus.`);
      loadData();
    }

    // ğŸ”¹ EKSPOR EXCEL
    function exportToExcel() {
      const rows = [];
      const trs = tabelBody.querySelectorAll("tr");
      trs.forEach((tr, i) => {
        const cells = tr.querySelectorAll("td");
        if (cells.length > 1) {
          rows.push({
            No: cells[0].innerText,
            Nama: cells[1].innerText,
            Tanggal: cells[2].innerText,
            Level1: cells[3].innerText,
            Level2: cells[4].innerText,
            Level3: cells[5].innerText,
          });
        }
      });

      if (rows.length === 0) {
        alert("Tidak ada data untuk diekspor.");
        return;
      }

      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data Asasmen");
      XLSX.writeFile(wb, "Rekap_Asasmen_Pengasuh.xlsx");
    }

    // ğŸ”¹ Event Listeners
    toggleDeleteBtn.addEventListener("click", () => deletePanel.classList.toggle("hidden"));
    filterBtn.addEventListener("click", filterByDate);
    deleteRangeBtn.addEventListener("click", deleteByDateRange);
    refreshBtn.addEventListener("click", loadData);
    exportBtn.addEventListener("click", exportToExcel);

    // ğŸ”¹ Load awal
    loadData();
  </script>
</body>
</html>
