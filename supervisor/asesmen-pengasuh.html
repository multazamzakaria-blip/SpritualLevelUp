<script type="module">
  import { db } from "../assets/firebase-config.js";
  import { collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const tabelBody = document.getElementById("tabel-body");
  const loading = document.getElementById("loading");
  const dataContainer = document.getElementById("data-container");
  const refreshBtn = document.getElementById("refresh-btn");

  async function loadData() {
    loading.classList.remove("hidden");
    dataContainer.classList.add("hidden");
    tabelBody.innerHTML = "";

    try {
      const q = query(collection(db, "asasmen_pengasuh"));
      const snapshot = await getDocs(q);
      if (snapshot.empty) {
        loading.textContent = "Belum ada data asesmen.";
        return;
      }

      let no = 1;
      snapshot.forEach((doc) => {
        const data = doc.data();
        const hasil = data.hasil || {};

        const sorted = Object.entries(hasil)
          .map(([level, score]) => ({ level, score }))
          .sort((a, b) => b.score - a.score)
          .slice(0, 3);

        const top1 = sorted[0] ? `${sorted[0].level} (${sorted[0].score})` : "-";
        const top2 = sorted[1] ? `${sorted[1].level} (${sorted[1].score})` : "-";
        const top3 = sorted[2] ? `${sorted[2].level} (${sorted[2].score})` : "-";

        const tr = `
          <tr class="odd:bg-gray-50 even:bg-gray-100 hover:bg-emerald-50 transition">
            <td class="border px-3 py-2">${no++}</td>
            <td class="border px-3 py-2 font-semibold text-left">${data.nama}</td>
            <td class="border px-3 py-2">${data.tanggal}</td>
            <td class="border px-3 py-2 text-emerald-700 font-semibold">${top1}</td>
            <td class="border px-3 py-2">${top2}</td>
            <td class="border px-3 py-2">${top3}</td>
          </tr>`;
        tabelBody.innerHTML += tr;
      });

      loading.classList.add("hidden");
      dataContainer.classList.remove("hidden");
    } catch (err) {
      console.error("‚ùå Error:", err);
      loading.textContent = "Terjadi kesalahan saat memuat data.";
    }
  }

  refreshBtn.addEventListener("click", loadData);
  loadData();
</script>
