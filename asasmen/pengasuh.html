<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asasmen Pengasuh Naik Level</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .answer-btn {
      transition: all 0.25s ease;
    }
    .answer-btn.selected {
      background-color: #a7f3d0; /* hijau muda lembut */
      border-color: #059669;
      color: #064e3b;
      font-weight: 600;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-emerald-100 to-teal-200 font-sans text-gray-800">

  <div class="max-w-xl mx-auto py-6 px-4">
    
    <!-- Header -->
    <header class="flex items-center gap-3 mb-6">
      <img src="../assets/logoslu.png" alt="Logo Pesantren" class="w-12 h-12 rounded-full bg-white shadow">
      <div>
        <h1 class="text-xl font-bold text-teal-700">Asasmen Pengasuh Naik Level</h1>
        <p class="text-xs text-gray-600">Refleksi 3 bulan terakhir perjalanan batin pengasuh</p>
      </div>
    </header>

    <!-- Info User -->
    <div id="userInfo" class="mb-4 bg-white/80 rounded-xl px-4 py-3 shadow-sm flex items-center justify-between">
      <div>
        <p class="text-xs text-gray-500">Pengasuh:</p>
        <p id="usernameDisplay" class="text-sm font-semibold text-teal-700">-</p>
      </div>
      <a href="../index.html" class="text-xs text-teal-700 underline">Kembali ke menu</a>
    </div>

    <!-- Progress -->
    <div class="mb-4">
      <div class="flex justify-between text-xs text-gray-600 mb-1">
        <span id="progressText">Pernyataan 1 dari 68</span>
        <span id="levelLabel" class="font-semibold text-teal-700"></span>
      </div>
      <div class="w-full bg-teal-100 rounded-full h-2">
        <div id="progressBar" class="bg-teal-500 h-2 rounded-full" style="width: 0%;"></div>
      </div>
    </div>

    <!-- Kartu Pertanyaan -->
    <div id="questionCard" class="bg-white/90 rounded-2xl shadow-lg p-5 mb-4">
      <p id="questionText" class="text-lg font-semibold text-gray-800 leading-relaxed mb-5 text-left"></p>

      <!-- Pilihan Jawaban -->
      <div class="grid grid-cols-2 gap-3 mb-4">
        <button class="answer-btn border rounded-xl py-3 px-3 text-sm font-medium bg-white" data-value="10">Tidak Pernah</button>
        <button class="answer-btn border rounded-xl py-3 px-3 text-sm font-medium bg-white" data-value="20">Kadang</button>
        <button class="answer-btn border rounded-xl py-3 px-3 text-sm font-medium bg-white" data-value="40">Sering</button>
        <button class="answer-btn border rounded-xl py-3 px-3 text-sm font-medium bg-white" data-value="80">Selalu</button>
      </div>

      <!-- Navigasi -->
      <div class="flex justify-between items-center text-xs">
        <button id="prevBtn" class="px-3 py-1 border border-teal-400 text-teal-700 rounded-lg disabled:opacity-30 disabled:cursor-not-allowed">â¬…ï¸ Sebelumnya</button>
        <button id="nextBtn" class="px-3 py-1 bg-teal-500 text-white rounded-lg disabled:opacity-30 disabled:cursor-not-allowed">Berikutnya â¡ï¸</button>
      </div>
    </div>

    <!-- Tombol Selesai -->
    <div class="flex justify-end mb-4">
      <button id="finishBtn" class="px-4 py-2 bg-emerald-600 text-white text-sm font-semibold rounded-lg shadow disabled:opacity-30 disabled:cursor-not-allowed">Selesai & Lihat Hasil</button>
    </div>

    <!-- Hasil -->
    <div id="resultBox" class="hidden bg-white/90 rounded-2xl shadow-lg p-5 mb-6">
      <h2 class="text-lg font-bold text-teal-700 mb-2">ğŸ¯ Tiga Level Paling Dominan</h2>
      <ol id="topLevelsList" class="list-decimal list-inside text-sm space-y-2 mb-3"></ol>
      <p id="saveStatus" class="text-[11px] font-semibold text-emerald-700"></p>
    </div>

    <footer class="text-center text-[11px] text-gray-500 mt-4">
      Â© 2025 Spritual Level Up Â· Pesantren Fajrul Islam
    </footer>
  </div>

  <script type="module">
    import { app, db } from "../assets/firebase-config.js";
    import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const user = JSON.parse(localStorage.getItem("naikLevelUser") || "null");
    if (!user) window.location.href = "../index.html";
    document.getElementById("usernameDisplay").textContent = user.username;

    const levelMeta = [
      { level: 1, name: "Level 1 â€“ Malu (Shame)" },
      { level: 2, name: "Level 2 â€“ Rasa Bersalah (Guilt)" },
      { level: 3, name: "Level 3 â€“ Apati (Apathy)" },
      { level: 4, name: "Level 4 â€“ Berduka (Grief)" },
      { level: 5, name: "Level 5 â€“ Takut (Fear)" },
      { level: 6, name: "Level 6 â€“ Keinginan (Desire)" },
      { level: 7, name: "Level 7 â€“ Marah (Anger)" },
      { level: 8, name: "Level 8 â€“ Bangga (Pride)" },
      { level: 9, name: "Level 9 â€“ Keberanian (Courage)" },
      { level: 10, name: "Level 10 â€“ Netralitas (Neutrality)" },
      { level: 11, name: "Level 11 â€“ Kemauan (Willingness)" },
      { level: 12, name: "Level 12 â€“ Penerimaan (Acceptance)" },
      { level: 13, name: "Level 13 â€“ Akal Budi (Reason)" },
      { level: 14, name: "Level 14 â€“ Cinta (Love)" },
      { level: 15, name: "Level 15 â€“ Sukacita (Joy)" },
      { level: 16, name: "Level 16 â€“ Damai (Peace)" },
      { level: 17, name: "Level 17 â€“ Pencerahan (Enlightenment)" }
    ];

    // ğŸ”¹ Daftar 68 pernyataan reflektif lengkap
    const questions = [
      { id: 1, level: 1, text: "Dalam 3 bulan ini, saya merasa tidak layak membimbing orang lain karena merasa diri saya penuh kekurangan." },
      { id: 2, level: 1, text: "Dalam 3 bulan ini, saya memilih menarik diri dari peran kepengasuhan karena takut dinilai atau disalahpahami." },
      { id: 3, level: 1, text: "Dalam 3 bulan ini, saya merasa Allah mungkin sudah tidak ridha atas pengabdian saya di pesantren." },
      { id: 4, level: 1, text: "Dalam 3 bulan ini, saya merasa kehadiran saya justru membebani orang lain, bukan membawa manfaat." },
      { id: 5, level: 2, text: "Dalam 3 bulan ini, saya sering teringat kesalahan masa lalu dan merasa belum pantas diampuni." },
      { id: 6, level: 2, text: "Dalam 3 bulan ini, saya menolak ketenangan batin karena merasa belum menebus dosa atau kelalaian saya sebagai pengasuh." },
      { id: 7, level: 2, text: "Dalam 3 bulan ini, saya berbuat baik dengan keras terhadap diri sendiri, bukan karena cinta, tapi karena ingin menebus kesalahan." },
      { id: 8, level: 2, text: "Dalam 3 bulan ini, saya sulit memaafkan diri sendiri meski saya yakin Allah Maha Pengampun." },
      { id: 9, level: 3, text: "Dalam 3 bulan ini, saya menjalankan peran pengasuhan secara mekanis, tanpa semangat dan tanpa makna." },
      { id: 10, level: 3, text: "Dalam 3 bulan ini, saya merasa perubahan di pesantren percuma, seolah tidak ada yang bisa diperbaiki." },
      { id: 11, level: 3, text: "Dalam 3 bulan ini, saya kehilangan arah dan makna dari pengabdian saya." },
      { id: 12, level: 3, text: "Dalam 3 bulan ini, saya merasa mati rasa terhadap santri dan rekan kerja, seolah semua tidak lagi berarti." },
      { id: 13, level: 4, text: "Dalam 3 bulan ini, saya sering mengenang masa lalu saat suasana pesantren terasa lebih baik." },
      { id: 14, level: 4, text: "Dalam 3 bulan ini, saya merasa kesedihan atas perubahan di pesantren sulit saya lepaskan." },
      { id: 15, level: 4, text: "Dalam 3 bulan ini, saya merasa kehilangan semangat lama dan sulit menemukan kembali gairah membina santri." },
      { id: 16, level: 4, text: "Dalam 3 bulan ini, saya sering menyesali keputusan atau sikap saya di masa lalu." },
      { id: 17, level: 5, text: "Dalam 3 bulan ini, saya menjalankan peran dengan cemas â€” takut salah, takut dikritik, atau takut mengecewakan pimpinan." },
      { id: 18, level: 5, text: "Dalam 3 bulan ini, saya menghindari menegur atau mengambil keputusan karena takut menimbulkan konflik." },
      { id: 19, level: 5, text: "Dalam 3 bulan ini, saya banyak memikirkan hal-hal buruk yang mungkin terjadi pada diri atau pesantren." },
      { id: 20, level: 5, text: "Dalam 3 bulan ini, saya menjaga jarak dengan santri atau guru karena takut terluka secara emosional." },
      { id: 21, level: 6, text: "Dalam 3 bulan ini, saya merasa gelisah bila program atau gagasan saya tidak dihargai." },
      { id: 22, level: 6, text: "Dalam 3 bulan ini, saya membandingkan diri dengan pengasuh lain dan merasa iri dengan pencapaian mereka." },
      { id: 23, level: 6, text: "Dalam 3 bulan ini, saya merasa terus mengejar sesuatu tapi tidak pernah benar-benar puas." },
      { id: 24, level: 6, text: "Dalam 3 bulan ini, saya merasa semangat saya muncul hanya bila ada pujian, penghargaan, atau perhatian dari orang lain." },
      { id: 25, level: 7, text: "Dalam 3 bulan ini, saya mudah tersinggung terhadap ucapan, perilaku, atau keputusan orang lain di pesantren." },
      { id: 26, level: 7, text: "Dalam 3 bulan ini, suasana di sekitar saya sering menjadi tegang karena sikap saya yang keras atau reaktif." },
      { id: 27, level: 7, text: "Dalam 3 bulan ini, saya menyimpan kekecewaan pada orang yang tidak sejalan dengan saya." },
      { id: 28, level: 7, text: "Dalam 3 bulan ini, saya sering menyalahkan keadaan atau orang lain atas hasil yang tidak sesuai harapan." },
      { id: 29, level: 8, text: "Dalam 3 bulan ini, saya sulit menerima masukan dari pengurus atau rekan sejawat yang lebih muda." },
      { id: 30, level: 8, text: "Dalam 3 bulan ini, saya berusaha terlihat kuat dan sempurna agar tidak kehilangan wibawa." },
      { id: 31, level: 8, text: "Dalam 3 bulan ini, saya menilai orang lain dari penampilan dan hasil lahiriah lebih dari niat dan perjuangannya." },
      { id: 32, level: 8, text: "Dalam 3 bulan ini, saya cenderung mencari pembenaran diri saat salah, agar tetap terlihat benar di hadapan orang lain." },
      { id: 33, level: 9, text: "Dalam 3 bulan ini, saya berani mengakui kesalahan di hadapan santri atau rekan kerja tanpa takut kehilangan wibawa." },
      { id: 34, level: 9, text: "Dalam 3 bulan ini, saya memandang setiap masalah di pesantren sebagai tantangan yang bisa memperkuat tim." },
      { id: 35, level: 9, text: "Dalam 3 bulan ini, saya mengambil langkah inisiatif untuk memperbaiki keadaan tanpa menunggu perintah." },
      { id: 36, level: 9, text: "Dalam 3 bulan ini, saya merasa yakin bahwa Allah akan menolong selama saya jujur dan berusaha." },
      { id: 37, level: 10, text: "Dalam 3 bulan ini, saya mampu menerima perubahan kebijakan atau dinamika pesantren dengan tenang." },
      { id: 38, level: 10, text: "Dalam 3 bulan ini, saya tidak terburu-buru menghakimi, tetapi berusaha memahami situasi dari berbagai sisi." },
      { id: 39, level: 10, text: "Dalam 3 bulan ini, saya bisa menyeimbangkan antara keseriusan bekerja dan waktu untuk istirahat." },
      { id: 40, level: 10, text: "Dalam 3 bulan ini, saya tidak berlebihan menyesali hasil yang kurang baik, karena percaya Allah menilai niat, bukan sekadar hasil." },
      { id: 41, level: 11, text: "Dalam 3 bulan ini, saya bekerja dengan antusias tanpa menunggu perintah, karena ingin memberi manfaat." },
      { id: 42, level: 11, text: "Dalam 3 bulan ini, saya terus belajar hal-hal baru agar bisa menjadi pengasuh yang lebih bijak dan relevan." },
      { id: 43, level: 11, text: "Dalam 3 bulan ini, saya menghadapi masalah pengasuhan dengan sikap belajar, bukan keluhan." },
      { id: 44, level: 11, text: "Dalam 3 bulan ini, saya berusaha konsisten menjaga niat tulus dalam setiap pelayanan di pesantren." },
      { id: 45, level: 12, text: "Dalam 3 bulan ini, saya mudah memaafkan guru, santri, atau staf yang berbuat salah." },
      { id: 46, level: 12, text: "Dalam 3 bulan ini, saya menerima diri saya apa adanya â€” dengan kelebihan dan keterbatasan." },
      { id: 47, level: 12, text: "Dalam 3 bulan ini, saya melihat hikmah dari setiap ujian, bahkan yang menyakitkan." },
      { id: 48, level: 12, text: "Dalam 3 bulan ini, saya tetap tenang di tengah konflik atau perbedaan pandangan." },
      { id: 49, level: 13, text: "Dalam 3 bulan ini, saya mengambil keputusan dengan berpikir jernih, berdasarkan data dan hikmah." },
      { id: 50, level: 13, text: "Dalam 3 bulan ini, saya mencintai ilmu dan terus belajar dari berbagai sumber untuk memperluas wawasan pengasuhan." },
      { id: 51, level: 13, text: "Dalam 3 bulan ini, saya sering menemukan tanda kebesaran Allah dalam sistem kehidupan pesantren yang tertata." },
      { id: 52, level: 13, text: "Dalam 3 bulan ini, saya menyampaikan pendapat dengan tenang, rasional, dan menghormati perbedaan." },
      { id: 53, level: 14, text: "Dalam 3 bulan ini, saya memperlakukan santri dan guru dengan kasih dan kelembutan hati." },
      { id: 54, level: 14, text: "Dalam 3 bulan ini, saya mudah memaafkan tanpa menuntut balasan atau permintaan maaf." },
      { id: 55, level: 14, text: "Dalam 3 bulan ini, saya membantu dan melayani dengan niat tulus, bukan demi pujian." },
      { id: 56, level: 14, text: "Dalam 3 bulan ini, saya melihat keindahan dan kebaikan Allah dalam setiap aspek kehidupan pesantren." },
      { id: 57, level: 15, text: "Dalam 3 bulan ini, saya merasa bahagia dan ringan dalam mengasuh, tanpa harus menunggu hasil besar." },
      { id: 58, level: 15, text: "Dalam 3 bulan ini, saya menerima ujian dan kritik dengan rasa syukur karena itu bagian dari tarbiyah Allah." },
            { id: 59, level: 15, text: "Dalam 3 bulan ini, saya membawa suasana cerah dan menenangkan bagi guru dan santri." },
      { id: 60, level: 15, text: "Dalam 3 bulan ini, saya menikmati momen sederhana di pesantren â€” kebersamaan, adzan, dan tawa santri â€” dengan rasa syukur." },
      { id: 61, level: 16, text: "Dalam 3 bulan ini, saya tetap tenang menghadapi berbagai persoalan pesantren." },
      { id: 62, level: 16, text: "Dalam 3 bulan ini, saya berhenti mengeluh dan lebih banyak berserah diri kepada Allah." },
      { id: 63, level: 16, text: "Dalam 3 bulan ini, kehadiran saya membuat orang lain merasa tenteram dan percaya diri." },
      { id: 64, level: 16, text: "Dalam 3 bulan ini, saya merasakan ibadah bukan sekadar tugas, tapi perjumpaan yang saya rindukan." },
      { id: 65, level: 17, text: "Dalam 3 bulan ini, saya merasa semua yang terjadi di pesantren adalah bagian dari kehendak Allah yang sempurna." },
      { id: 66, level: 17, text: "Dalam 3 bulan ini, saya melihat kehadiran Allah dalam setiap jiwa yang saya temui." },
      { id: 67, level: 17, text: "Dalam 3 bulan ini, saya hidup dengan tenang tanpa dorongan ego â€” cukup menjadi saluran kebaikan-Nya." },
      { id: 68, level: 17, text: "Dalam 3 bulan ini, saya merasa kehadiran saya membawa kedamaian tanpa perlu banyak bicara." }
    ];

    let currentIndex = 0;
    const answers = new Array(questions.length).fill(null);

    const qText = document.getElementById("questionText");
    const progressText = document.getElementById("progressText");
    const progressBar = document.getElementById("progressBar");
    const levelLabel = document.getElementById("levelLabel");
    const answerBtns = document.querySelectorAll(".answer-btn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const finishBtn = document.getElementById("finishBtn");
    const topList = document.getElementById("topLevelsList");
    const resultBox = document.getElementById("resultBox");
    const saveStatus = document.getElementById("saveStatus");

    // ğŸ”¹ Fungsi tampilkan pertanyaan
    function renderQuestion() {
      const q = questions[currentIndex];
      qText.textContent = q.text;
      progressText.textContent = `Pernyataan ${currentIndex + 1} dari ${questions.length}`;
      levelLabel.textContent = levelMeta.find(l => l.level === q.level).name;
      progressBar.style.width = `${((currentIndex + 1) / questions.length) * 100}%`;

      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex === questions.length - 1 || answers[currentIndex] === null;

      answerBtns.forEach(btn => {
        const val = Number(btn.dataset.value);
        btn.classList.toggle("selected", answers[currentIndex] === val);
      });

      // tombol selesai hanya aktif jika semua terisi
      finishBtn.disabled = !answers.every(a => a !== null);
    }

    // ğŸ”¹ Klik jawaban
    answerBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        answers[currentIndex] = Number(btn.dataset.value);
        renderQuestion();
        if (currentIndex < questions.length - 1) {
          currentIndex++;
          renderQuestion();
        }
      });
    });

    // ğŸ”¹ Navigasi sebelumnya dan berikutnya
    prevBtn.addEventListener("click", () => {
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentIndex < questions.length - 1 && answers[currentIndex] !== null) {
        currentIndex++;
        renderQuestion();
      }
    });

    // ğŸ”¹ Proses hasil akhir & simpan ke Firebase
    finishBtn.addEventListener("click", async () => {
      const levelScores = {};
      levelMeta.forEach(l => levelScores[l.level] = 0);
      questions.forEach((q, i) => levelScores[q.level] += answers[i]);

      const sorted = levelMeta.map(l => ({
        level: l.level, name: l.name, score: levelScores[l.level]
      })).sort((a,b)=>b.score-a.score);
      const top3 = sorted.slice(0,3);

      topList.innerHTML = top3.map(t => `<li>${t.name}</li>`).join("");
      resultBox.classList.remove("hidden");
      saveStatus.textContent = "â³ Menyimpan ke Firebase...";

      try {
        await addDoc(collection(db, "asesmen_pengasuh"), {
          username: user.username,
          role: user.role,
          answers,
          levelScores,
          topLevels: top3,
          createdAt: serverTimestamp()
        });
        saveStatus.textContent = "âœ… Hasil tersimpan ke server.";
      } catch (err) {
        console.error(err);
        saveStatus.textContent = "âŒ Gagal menyimpan ke Firebase.";
      }
    });

    // Jalankan tampilan awal
    renderQuestion();
  </script>
</body>
</html>

