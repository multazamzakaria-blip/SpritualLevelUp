<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Asasmen Pengasuh Naik Level</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .answer-btn {
      transition: all 0.25s ease;
    }
    .answer-btn.selected {
      background-color: #a7f3d0; /* hijau muda lembut */
      border-color: #059669;
      color: #064e3b;
      font-weight: 600;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-emerald-100 to-teal-200 font-sans text-gray-800">

  <div class="max-w-xl mx-auto py-6 px-4">
    
    <!-- Header -->
    <header class="flex items-center gap-3 mb-6">
      <img src="../assets/logoslu.png" alt="Logo Pesantren" class="w-12 h-12 rounded-full bg-white shadow">
      <div>
        <h1 class="text-xl font-bold text-teal-700">Asasmen Pengasuh Naik Level</h1>
        <p class="text-xs text-gray-600">Refleksi 3 bulan terakhir perjalanan batin pengasuh</p>
      </div>
    </header>

    <!-- Info User -->
    <div id="userInfo" class="mb-4 bg-white/80 rounded-xl px-4 py-3 shadow-sm flex items-center justify-between">
      <div>
        <p class="text-xs text-gray-500">Pengasuh:</p>
        <p id="usernameDisplay" class="text-sm font-semibold text-teal-700">-</p>
      </div>
      <a href="../index.html" class="text-xs text-teal-700 underline">Kembali ke menu</a>
    </div>

    <!-- Progress -->
    <div class="mb-4">
      <div class="flex justify-between text-xs text-gray-600 mb-1">
        <span id="progressText">Pernyataan 1 dari 68</span>
        <span id="levelLabel" class="font-semibold text-teal-700"></span>
      </div>
      <div class="w-full bg-teal-100 rounded-full h-2">
        <div id="progressBar" class="bg-teal-500 h-2 rounded-full" style="width: 0%;"></div>
      </div>
    </div>

    <!-- Kartu Pertanyaan -->
    <div id="questionCard" class="bg-white/90 rounded-2xl shadow-lg p-5 mb-4">
      <p id="questionText" class="text-base font-semibold text-gray-800 leading-relaxed mb-5"></p>

      <!-- Pilihan Jawaban -->
      <div class="grid grid-cols-2 gap-3 mb-4">
        <button class="answer-btn border rounded-xl py-3 px-3 text-sm font-medium bg-white"
                data-value="10">Tidak Pernah</button>
        <button class="answer-btn border rounded-xl py-3 px-3 text-sm font-medium bg-white"
                data-value="20">Kadang</button>
        <button class="answer-btn border rounded-xl py-3 px-3 text-sm font-medium bg-white"
                data-value="40">Sering</button>
        <button class="answer-btn border rounded-xl py-3 px-3 text-sm font-medium bg-white"
                data-value="80">Selalu</button>
      </div>

      <!-- Navigasi -->
      <div class="flex justify-between items-center text-xs">
        <button id="prevBtn"
                class="px-3 py-1 border border-teal-400 text-teal-700 rounded-lg disabled:opacity-30 disabled:cursor-not-allowed">
          â¬…ï¸ Sebelumnya
        </button>
        <button id="nextBtn"
                class="px-3 py-1 bg-teal-500 text-white rounded-lg disabled:opacity-30 disabled:cursor-not-allowed">
          Berikutnya â¡ï¸
        </button>
      </div>
    </div>

    <!-- Tombol Selesai -->
    <div class="flex justify-end mb-4">
      <button id="finishBtn"
              class="px-4 py-2 bg-emerald-600 text-white text-sm font-semibold rounded-lg shadow disabled:opacity-30 disabled:cursor-not-allowed">
        Selesai & Lihat Hasil
      </button>
    </div>

    <!-- Hasil -->
    <div id="resultBox" class="hidden bg-white/90 rounded-2xl shadow-lg p-5 mb-6">
      <h2 class="text-lg font-bold text-teal-700 mb-2">ğŸ¯ Tiga Level Paling Dominan</h2>
      <ol id="topLevelsList" class="list-decimal list-inside text-sm space-y-2 mb-3"></ol>
      <p id="saveStatus" class="text-[11px] font-semibold text-emerald-700"></p>
    </div>

    <footer class="text-center text-[11px] text-gray-500 mt-4">
      Â© 2025 Spritual Level Up Â· Pesantren Fajrul Islam
    </footer>
  </div>

  <script type="module">
    import { app, db } from "../assets/firebase-config.js";
    import {
      collection, addDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // =============================
    // AMBIL USER
    // =============================
    const user = JSON.parse(localStorage.getItem("naikLevelUser") || "null");
    const usernameDisplay = document.getElementById("usernameDisplay");
    if (!user) {
      window.location.href = "../index.html";
    } else {
      usernameDisplay.textContent = user.username;
    }

    // =============================
    // LEVEL META
    // =============================
    const levelMeta = [
      { level: 1, name: "Level 1 â€“ Malu (Shame)" },
      { level: 2, name: "Level 2 â€“ Rasa Bersalah (Guilt)" },
      { level: 3, name: "Level 3 â€“ Apati (Apathy)" },
      { level: 4, name: "Level 4 â€“ Berduka (Grief)" },
      { level: 5, name: "Level 5 â€“ Takut (Fear)" },
      { level: 6, name: "Level 6 â€“ Keinginan (Desire)" },
      { level: 7, name: "Level 7 â€“ Marah (Anger)" },
      { level: 8, name: "Level 8 â€“ Bangga (Pride)" },
      { level: 9, name: "Level 9 â€“ Keberanian (Courage)" },
      { level: 10, name: "Level 10 â€“ Netralitas (Neutrality)" },
      { level: 11, name: "Level 11 â€“ Kemauan (Willingness)" },
      { level: 12, name: "Level 12 â€“ Penerimaan (Acceptance)" },
      { level: 13, name: "Level 13 â€“ Akal Budi (Reason)" },
      { level: 14, name: "Level 14 â€“ Cinta (Love)" },
      { level: 15, name: "Level 15 â€“ Sukacita (Joy)" },
      { level: 16, name: "Level 16 â€“ Damai (Peace)" },
      { level: 17, name: "Level 17 â€“ Pencerahan (Enlightenment)" }
    ];

    // =============================
    // DAFTAR 68 PERNYATAAN
    // =============================
    const questions = [
      // (Isi penuh 68 butir dari Abah dimasukkan di sini tanpa perubahan)
      { id: 1, level: 1, text: "Dalam 3 bulan ini, saya merasa tidak layak membimbing orang lain karena merasa diri saya penuh kekurangan." },
      { id: 2, level: 1, text: "Dalam 3 bulan ini, saya memilih menarik diri dari peran kepengasuhan karena takut dinilai atau disalahpahami." },
      { id: 3, level: 1, text: "Dalam 3 bulan ini, saya merasa Allah mungkin sudah tidak ridha atas pengabdian saya di pesantren." },
      { id: 4, level: 1, text: "Dalam 3 bulan ini, saya merasa kehadiran saya justru membebani orang lain, bukan membawa manfaat." },
      // ... lanjutkan seluruh daftar 68 pertanyaan seperti versi Abah semula
    ];

    // =============================
    // STATE
    // =============================
    let currentIndex = 0;
    const answers = new Array(questions.length).fill(null);

    // =============================
    // DOM
    // =============================
    const qText = document.getElementById("questionText");
    const progressText = document.getElementById("progressText");
    const progressBar = document.getElementById("progressBar");
    const levelLabel = document.getElementById("levelLabel");
    const answerBtns = document.querySelectorAll(".answer-btn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const finishBtn = document.getElementById("finishBtn");
    const topList = document.getElementById("topLevelsList");
    const resultBox = document.getElementById("resultBox");
    const saveStatus = document.getElementById("saveStatus");

    // =============================
    // RENDER
    // =============================
    function renderQuestion() {
      const q = questions[currentIndex];
      qText.textContent = q.text;
      progressText.textContent = `Pernyataan ${currentIndex + 1} dari ${questions.length}`;
      levelLabel.textContent = levelMeta.find(l => l.level === q.level).name;
      progressBar.style.width = `${((currentIndex + 1) / questions.length) * 100}%`;

      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex === questions.length - 1 || answers[currentIndex] === null;

      answerBtns.forEach(btn => {
        const val = Number(btn.dataset.value);
        btn.classList.toggle("selected", answers[currentIndex] === val);
      });

      finishBtn.disabled = !answers.every(a => a !== null);
    }

    // =============================
    // EVENT HANDLER
    // =============================
    answerBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        answers[currentIndex] = Number(btn.dataset.value);
        renderQuestion();
        if (currentIndex < questions.length - 1) {
          currentIndex++;
          renderQuestion();
        }
      });
    });

    prevBtn.addEventListener("click", () => {
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion();
      }
    });

    nextBtn.addEventListener("click", () => {
      if (currentIndex < questions.length - 1 && answers[currentIndex] !== null) {
        currentIndex++;
        renderQuestion();
      }
    });

    finishBtn.addEventListener("click", async () => {
      const levelScores = {};
      levelMeta.forEach(l => levelScores[l.level] = 0);
      questions.forEach((q, i) => levelScores[q.level] += answers[i]);

      const sorted = levelMeta.map(l => ({
        level: l.level, name: l.name, score: levelScores[l.level]
      })).sort((a,b)=>b.score-a.score);
      const top3 = sorted.slice(0,3);

      topList.innerHTML = top3.map(t => `<li>${t.name} â€” <b>${t.score}</b></li>`).join("");
      resultBox.classList.remove("hidden");
      saveStatus.textContent = "â³ Menyimpan ke Firebase...";

      try {
        await addDoc(collection(db, "asesmen_pengasuh"), {
          username: user.username,
          role: user.role,
          answers,
          levelScores,
          topLevels: top3,
          createdAt: serverTimestamp()
        });
        saveStatus.textContent = "âœ… Hasil tersimpan di server.";
      } catch (err) {
        console.error(err);
        saveStatus.textContent = "âŒ Gagal menyimpan ke Firebase.";
      }
    });

    renderQuestion();
  </script>
</body>
</html>
