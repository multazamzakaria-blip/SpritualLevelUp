<script type="module">
  import { db } from "../assets/firebase-config.js";
  import { collection, addDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // ===== DATA PERTANYAAN =====
  const levels = [
    "MALU (Shame)", "RASA BERSALAH (Guilt)", "APATI (Apathy)", "BERDUKA (Grief)", "TAKUT (Fear)",
    "KEINGINAN (Desire)", "MARAH (Anger)", "BANGGA (Pride)", "KEBERANIAN (Courage)", "NETRALITAS (Neutrality)",
    "KEMAUAN (Willingness)", "PENERIMAAN (Acceptance)", "AKAL BUDI (Reason)", "CINTA (Love)",
    "SUKACITA (Joy)", "DAMAI (Peace)", "PENCERAHAN (Enlightenment)"
  ];

  // ... (daftar 68 pernyataan seperti sebelumnya)

  // ===== VARIABEL =====
  const startBtn = document.getElementById("start-btn");
  const introContainer = document.getElementById("intro-container");
  const questionContainer = document.getElementById("question-container");
  const questionText = document.getElementById("question-text");
  const progressText = document.getElementById("progress-text");
  const resultContainer = document.getElementById("result-container");
  const topLevels = document.getElementById("top-levels");
  const restartBtn = document.getElementById("restart-btn");
  let nama = "";
  let current = 0;
  const scores = {};

  // ===== MULAI =====
  startBtn.addEventListener("click", () => {
    nama = document.getElementById("nama").value.trim();
    if (!nama) {
      alert("Masukkan nama terlebih dahulu!");
      return;
    }
    introContainer.classList.add("hidden");
    questionContainer.classList.remove("hidden");
    showQuestion();
  });

  function showQuestion() {
    questionText.textContent = statements[current];
    progressText.textContent = `Pertanyaan ${current + 1} dari ${statements.length}`;
  }

  document.querySelectorAll(".answer-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const score = parseInt(btn.dataset.score);
      const levelIndex = Math.floor(current / 4);
      const level = levels[levelIndex];
      scores[level] = (scores[level] || 0) + score;
      current++;

      if (current < statements.length) {
        showQuestion();
      } else {
        await saveToFirebase();
        showResult();
      }
    });
  });

  async function saveToFirebase() {
    try {
      await addDoc(collection(db, "asasmen_pengasuh"), {
        nama,
        tanggal: new Date().toLocaleString("id-ID"),
        hasil: scores
      });
      console.log("✅ Data tersimpan di Firestore");
    } catch (err) {
      console.error("❌ Gagal menyimpan:", err);
    }
  }

  function showResult() {
    questionContainer.classList.add("hidden");
    resultContainer.classList.remove("hidden");

    const sorted = Object.entries(scores)
      .map(([level, score]) => ({ level, score }))
      .sort((a, b) => b.score - a.score)
      .slice(0, 3);

    topLevels.innerHTML = sorted.map((l, i) => `
      <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded text-left">
        <span class="font-bold text-blue-700">#${i + 1}</span> ${l.level} — <span class="text-gray-600">${l.score} poin</span>
      </div>`).join("");
  }

  restartBtn.addEventListener("click", () => location.reload());
</script>
